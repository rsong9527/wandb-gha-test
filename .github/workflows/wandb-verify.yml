name: W&B Verify Test

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  wandb-verify-staging:
    name: "W&B Verify - Staging Environment"
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…W&B
      run: |
        python -m pip install --upgrade pip
        pip install wandb>=0.21.3
        
    - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        echo "=== ç¯å¢ƒä¿¡æ¯ ==="
        echo "Python: $(python --version)"
        echo "W&B: $(python -c 'import wandb; print(wandb.__version__)')"
        echo "Runner: $RUNNER_OS"
        echo "CI: $CI"
        echo "GITHUB_ACTIONS: $GITHUB_ACTIONS"
        
    - name: W&B Verify - Stagingç¯å¢ƒ
      env:
        WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
        WANDB_BASE_URL: https://staging-aws.wandb.io
      run: |
        echo "=== W&B Verify - Stagingç¯å¢ƒ ==="
        echo "Base URL: $WANDB_BASE_URL"
        echo "API Keyè®¾ç½®: ${{ secrets.WANDB_API_KEY != '' }}"
        
        # è¿è¡Œwandb verifyå¹¶æ•è·è¾“å‡º
        echo "å¼€å§‹è¿è¡Œ wandb verify..."
        wandb verify || echo "wandb verify æ‰§è¡Œå®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šæˆ–é”™è¯¯ï¼‰"
        
    - name: æµ‹è¯•åŸºæœ¬W&BåŠŸèƒ½
      env:
        WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
        WANDB_BASE_URL: https://staging-aws.wandb.io
      run: |
        echo "=== æµ‹è¯•åŸºæœ¬W&BåŠŸèƒ½ ==="
        python -c "
        import wandb
        import os
        
        print('ğŸ”„ æµ‹è¯•W&BåŸºæœ¬åŠŸèƒ½...')
        
        # æµ‹è¯•ç™»å½•
        try:
            api = wandb.Api()
            user = api.viewer
            print(f'âœ… W&B APIè¿æ¥æˆåŠŸ: {user}')
        except Exception as e:
            print(f'âŒ W&B APIè¿æ¥å¤±è´¥: {e}')
        
        # æµ‹è¯•ç®€å•çš„è¿è¡Œåˆ›å»º
        try:
            run = wandb.init(project='verify-test', name='gha-verify-test')
            wandb.log({'test_metric': 1.0})
            wandb.finish()
            print('âœ… W&Bè¿è¡Œåˆ›å»ºæˆåŠŸ')
        except Exception as e:
            print(f'âŒ W&Bè¿è¡Œåˆ›å»ºå¤±è´¥: {e}')
        "

  # å¦‚æœæœ‰è®¿é—®æƒé™ï¼Œå¯ä»¥æµ‹è¯•WovenæœåŠ¡å™¨
  # wandb-verify-woven:
  #   name: "W&B Verify - Woven Environment"  
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #   - name: Checkoutä»£ç 
  #     uses: actions/checkout@v4
  #     
  #   - name: è®¾ç½®Python
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: '3.9'
  #       
  #   - name: å®‰è£…W&B
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install wandb>=0.21.3
  #       
  #   - name: W&B Verify - Wovenç¯å¢ƒ
  #     env:
  #       WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
  #       WANDB_BASE_URL: https://wb.swp-ml.tri-ad.global
  #     run: |
  #       echo "=== W&B Verify - Wovenç¯å¢ƒ ==="
  #       echo "Base URL: $WANDB_BASE_URL"
  #       
  #       # æµ‹è¯•è¿æ¥æ€§
  #       echo "æµ‹è¯•WovenæœåŠ¡å™¨è¿æ¥æ€§..."
  #       curl -I https://wb.swp-ml.tri-ad.global/health || echo "æ— æ³•è¿æ¥åˆ°WovenæœåŠ¡å™¨"
  #       
  #       # è¿è¡Œwandb verify
  #       echo "å¼€å§‹è¿è¡Œ wandb verify..."
  #       wandb verify || echo "wandb verify æ‰§è¡Œå®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šæˆ–é”™è¯¯ï¼‰"
